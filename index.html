<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WB Police Force Details</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
        }

        #map {
            height: 100vh;
        }

        .header {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(90deg, #0d47a1, #1976d2);
            color: white;
            padding: 10px 24px;
            border-radius: 30px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        .legend,
        .filterBox {
            position: absolute;
            background: white;
            padding: 12px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .legend {
            bottom: 20px;
            left: 20px;
            font-size: 13px;
        }

        .filterBox {
            top: 80px;
            left: 20px;
        }

        .popup-card {
            min-width: 180px;
        }

        .popup-title {
            font-weight: 700;
            font-size: 16px;
            color: #0d47a1;
            margin-bottom: 6px;
        }

        .popup-type {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 14px;
            font-size: 12px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, #3949ab, #1e88e5);
        }
    </style>
</head>

<body>

    <div class="header"> WB Police Force Details</div>

    <div class="filterBox">
        <b>Filter by Unit Type</b><br>
        <select id="typeFilter">
            <option value="ALL">All Units</option>
        </select>
        <br><br>
        <input type="text" id="searchBox" placeholder="Search unit name..." style="width:160px;padding:4px;">
    </div>


    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <script>
var map = L.map('map', { zoomControl: true }).setView([23.5, 87.5], 7);

// üåç Premium Map Layer
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap',
    maxZoom: 19
}).addTo(map);

// üî• Cluster Group
var markers = L.markerClusterGroup({
    disableClusteringAtZoom: 13,
    spiderfyOnMaxZoom: true,
    showCoverageOnHover: false
});
map.addLayer(markers);

// üì° TSV DATA SOURCE
var sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQws1aF25SY9EK4d2o455DnhKd136BwBn7jhJ_PP4L6lLDU1j9cRiLyZf0ilCaeH0D1mz8RgwQoLV9k/pub?gid=0&single=true&output=tsv";

// üé® HQ COLOR MAP
function getHQColor(hq) {
    const colors = {
        "DG": "#FF0000",
        "HQ": "#0000FF",
        "DMG": "#00FF00",
        "PS": "#FFFF00",
        "TG": "#FF00FF",
        "STG": "#7FFFD4",
        "OP": "#A52A2A",
        "TOP": "#808000",
        "IC": "#008000",
        "ROP": "#FFA500",
        "BOP": "#ADD8E6",
        "CAMP": "#00FFFF"
    };
    return colors[hq] || "#555555";
}

// ‚≠ê Premium Glowing Icon
function createPremiumIcon(color) {
    return L.divIcon({
        className: '',
        html: `<div style="
            width:18px;height:18px;
            background:${color};
            border-radius:50%;
            border:3px solid white;
            box-shadow:0 0 6px ${color},0 0 10px ${color},0 0 16px ${color};
        "></div>`,
        iconSize: [24, 24],
        iconAnchor: [12, 12]
    });
}

var allMarkersData = [];

// üöÄ LOAD DATA
function loadData(selectedType = "ALL", searchText = "") {

    markers.clearLayers();
    allMarkersData = [];

    fetch(sheetURL)
    .then(r => r.text())
    .then(data => {

        var rows = data.trim().split("\n");
        var typesSet = new Set();
        var bounds = [];

        for (var i = 1; i < rows.length; i++) {

            var cols = rows[i].split("\t");

            var type = cols[1]?.trim() || "Unit";   // Column B
            var caption = cols[28]?.trim();         // Column AC
            var lat = parseFloat(cols[29]);         // Column AD
            var lon = parseFloat(cols[30]);         // Column AE
            var hq = cols[31]?.trim() || "";        // Column AF

            if (!caption || isNaN(lat) || isNaN(lon)) continue;
            if (selectedType !== "ALL" && type !== selectedType) continue;
            if (searchText && !caption.toLowerCase().includes(searchText.toLowerCase())) continue;

            typesSet.add(type);

            var color = getHQColor(hq);

            // üéØ Smart formatting of AC column
            // üéØ Smart formatting of AC column
var lines = caption.split(/\n+/);

var unitName = lines[0] || "";
var actualStrengthLine = lines.find(l => l.toLowerCase().includes("actual strength")) || "";
var availableStrengthLine = lines.find(l => l.toLowerCase().includes("available strength")) || "";
var contactLine = lines.find(l => l.toLowerCase().includes("contact")) || "";

// Remove headings and extra text
var actualStrength = actualStrengthLine
    .replace(/actual strength/gi, "")
    .replace(/---/g, "")
    .trim();

var availableStrength = availableStrengthLine
    .replace(/available strength/gi, "")
    .replace(/---/g, "")
    .trim();

var contact = contactLine
    .replace(/contact no[:\-]*/gi, "")
    .trim();

var marker = L.marker([lat, lon], {
    icon: createPremiumIcon(color)
}).bindPopup(`
    <div style="min-width:220px;font-family:Segoe UI;line-height:1.5">

        <!-- Unit Name -->
        <div style="font-weight:700;font-size:15px;color:#0d47a1;margin-bottom:6px;">
            ${unitName}
        </div>

        <!-- Actual Strength -->
        ${actualStrength ? `
        <div style="margin-bottom:6px;">
            <b style="color:#2e7d32;">Actual Strength</b><br>
            ${actualStrength}
        </div>` : ""}

        <!-- Available Strength -->
        ${availableStrength ? `
        <div style="margin-bottom:6px;">
            <b style="color:#ef6c00;">Available Strength</b><br>
            ${availableStrength}
        </div>` : ""}

        <!-- Contact -->
        ${contact ? `
        <div style="margin-top:6px;padding-top:6px;border-top:1px solid #ddd;">
            üìû ${contact}
        </div>` : ""}

        <!-- Type Badge -->
        <div style="margin-top:8px;">
            <span style="
                background:linear-gradient(135deg,#3949ab,#1e88e5);
                color:white;
                padding:4px 10px;
                border-radius:12px;
                font-size:11px;
                font-weight:600;">
                ${type}
            </span>
        </div>
    </div>
`);


             markers.addLayer(marker);
            allMarkersData.push(marker);
            bounds.push([lat, lon]);

        } // ‚úÖ CLOSE FOR LOOP HERE

        // Populate Filter (run ONCE, not per row)
        var filter = document.getElementById("typeFilter");
        if (filter.options.length <= 1) {
            typesSet.forEach(t => {
                var opt = document.createElement("option");
                opt.value = t;
                opt.text = t;
                filter.appendChild(opt);
            });
        }

        // Auto fit map to markers
        if (bounds.length > 0) {
            map.fitBounds(bounds, { padding: [30, 30] });
        }

    }); // ‚úÖ CLOSE fetch().then(...)
} // ‚úÖ CLOSE loadData()


// üîÑ Initial Load
loadData();

// üéõ Type Filter
document.getElementById("typeFilter").addEventListener("change", function () {
    loadData(this.value, document.getElementById("searchBox").value);
});

// üîé Search Box
document.getElementById("searchBox").addEventListener("input", function () {
    loadData(document.getElementById("typeFilter").value, this.value);
});

// üîÅ AUTO REFRESH
setInterval(function () {
    loadData(document.getElementById("typeFilter").value, document.getElementById("searchBox").value);
}, 60000);

// üè∑ HQ COLOR LEGEND
var legend = L.control({ position: 'bottomright' });
legend.onAdd = function () {
    var div = L.DomUtil.create('div', 'legend');
    div.innerHTML += "<b>Legend</b><br>";

    const legendItems = {
        "DG Reserve": "#FF0000",
        "HQ": "#0000FF",
        "DMG": "#00FF00",
        "PS": "#FFFF00",
        "TG": "#FF00FF",
        "STG": "#7FFFD4",
        "OP": "#A52A2A",
        "TOP": "#808000",
        "IC": "#008000",
        "ROP": "#FFA500",
        "BOP": "#ADD8E6",
        "CAMP": "#00FFFF"
    };

    for (let key in legendItems) {
        div.innerHTML += `<div style="margin:4px 0;">
            <span style="display:inline-block;width:14px;height:14px;border-radius:50%;
            background:${legendItems[key]};margin-right:6px;"></span>${key}
        </div>`;
    }
    return div;
};
legend.addTo(map);
</script>

</body>

</html>
